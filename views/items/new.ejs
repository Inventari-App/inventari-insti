<% layout('layouts/boilerplate')%>
<div class="row">
  <h1 class="text-center mb-5">Nou item</h1>
  <div class="col-6 offset-3">
    <form action="/items" method="POST" class="validated-form">
      <div class="form-select mb-3">
        <input
          class="form-check-input"
          type="radio"
          name="naturalesa"
          required
          id="naturalesa2"
          value="inventariable"
          checked
        />
        <label class="form-check-label" for="inventariable">
          Inventariable
        </label>
      </div>

      <div class="form-select mb-3">
        <input
          class="form-check-input"
          type="radio"
          name="naturalesa"
          required
          id="naturalesa1"
          value="no_inventariable"
        />
        <label class="form-check-label" for="naturalesa1">
          No inventariable
        </label>
      </div>

      <p></p>
      <p></p>

      <div class="form-select mb-3">
        <label class="form-label" for="nom">Nom Item</label>
        <input class="form-control" type="text" id="nom" name="nom" required />
        <div class="valid-feedback">Sembla correcte!</div>
      </div>

      <select class="form-select mb-3" aria-label="tipus" name="tipus" required>
        <option selected>Escull un tipus d'article</option>
        <option value="maquinaria">Maquinària</option>
        <option value="moble">Moble</option>
        <option value="utillatge">Utillatge</option>
        <option value="Consumible">Consumible</option>
        <option value="construccio">Material de construcciò</option>
        <option value="lampisteria">Material elèctric i lampisteria</option>
      </select>

      <div class="mb-3">
        <label class="form-label" for="descripcio">Descripció</label>
        <textarea
          class="form-control"
          type="text"
          id="descripcio"
          name="descripcio"
        ></textarea>
      </div>

      <div class="mb-3">
        <button class="btn btn-success">Afegeix Item</button>
      </div>
    </form>
    <a href="/items">Tots els Items</a>
  </div>
</div>

<script>
  const formEl = document.querySelector("form");
  const queryString = window.location.search;
  const urlParams = new URLSearchParams(queryString);
  const tab = urlParams.get("tab");

  const inputEls = document.querySelectorAll(
    'input[type="text"], input[type="radio"]:checked, select, textarea'
  );

  formEl.addEventListener("submit", async function (event) {
    event.preventDefault();
    const formData = Array.prototype.reduce.call(
      inputEls,
      (acc, inputEl) => {
        const key = inputEl.name;
        const value = inputEl.value;
        return { ...acc, [key]: value };
      },
      {}
    );
    console.log(formData);

    const response = await fetch("/items", {
      method: "POST",
      headers: {
        "Content-Type": "application/json",
      },
      body: JSON.stringify({ item: formData }),
    });
    const item = await response.json()

    if (tab) {
        window.close();
    } else {
        window.location.href = `/items/${item._id}`
    }
  });
</script>
